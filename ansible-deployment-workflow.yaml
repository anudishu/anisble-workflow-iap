# =========================================================================
# GOOGLE CLOUD WORKFLOW - ANSIBLE IAP DEPLOYMENT AUTOMATION
# =========================================================================
# 
# This workflow automates the execution of Ansible playbooks via IAP tunneling
# for secure VM configuration and software deployment.
# 
# Author: DevOps Automation Team
# Version: 1.0
# Last Updated: November 2025
# =========================================================================

main:
  params: [input]
  steps:
    - init:
        assign:
          # Extract parameters from input or use defaults
          - project_id: ${default(map.get(input, "project_id"), "probable-cove-474504-p0")}
          - location_id: ${default(map.get(input, "location_id"), "global")}
          - target_vm: ${default(map.get(input, "target_vm"), "ansible-rhel9-vm")}
          - vm_zone: ${default(map.get(input, "vm_zone"), "us-central1-a")}
          - playbook: ${default(map.get(input, "playbook"), "golden-image-rhel9.yml")}
          - ansible_user: ${default(map.get(input, "ansible_user"), "askcloudedge_gmail_com")}
          - service_account: ${default(map.get(input, "service_account"), "")}
          - git_repo: ${default(map.get(input, "git_repo"), "https://github.com/anudishu/ansible-updated-code-iap.git")}
          - git_branch: ${default(map.get(input, "git_branch"), "master")}
          - skip_validation: ${default(map.get(input, "skip_validation"), false)}
          - deployment_id: ${text.replace_all(sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID"), "-", "")}

    - validate_inputs:
        switch:
          - condition: ${len(target_vm) == 0}
            raise:
              message: "target_vm parameter is required"
          - condition: ${len(project_id) == 0}
            raise:
              message: "project_id parameter is required"

    - log_start:
        call: sys.log
        args:
          text: "Starting Ansible deployment workflow"
          severity: "INFO"

    # Step 1: Verify VM exists and is accessible
    - verify_vm:
        call: verify_target_vm
        args:
          project_id: ${project_id}
          location_id: ${location_id}
          target_vm: ${target_vm}
          vm_zone: ${vm_zone}
        result: vm_status

    # Step 2: Run Ansible deployment
    - ansible_deployment:
        call: run_ansible_playbook
        args:
          project_id: ${project_id}
          location_id: ${location_id}
          target_vm: ${target_vm}
          vm_zone: ${vm_zone}
          playbook: ${playbook}
          ansible_user: ${ansible_user}
          service_account: ${service_account}
          git_repo: ${git_repo}
          git_branch: ${git_branch}
          deployment_id: ${deployment_id}
        result: deployment_result

    # Step 3: Run validation (optional)
    - validation_step:
        switch:
          - condition: ${skip_validation}
            next: return_results
          - condition: true
            call: run_validation
            args:
              project_id: ${project_id}
              location_id: ${location_id}
              target_vm: ${target_vm}
              vm_zone: ${vm_zone}
              ansible_user: ${ansible_user}
              service_account: ${service_account}
              deployment_id: ${deployment_id}
            result: validation_result

    - return_results:
        return:
          status: "SUCCESS"
          deployment_id: ${deployment_id}
          vm_name: ${target_vm}
          playbook_executed: ${playbook}
          deployment_logs: ${deployment_result}
          validation_results: ${default(validation_result, "SKIPPED")}
          timestamp: ${time.format(sys.now(), "%Y-%m-%d %H:%M:%S UTC")}

# =========================================================================
# FUNCTION: VERIFY TARGET VM
# =========================================================================
verify_target_vm:
  params: [project_id, location_id, target_vm, vm_zone]
  steps:
    - check_vm:
        call: googleapis.cloudbuild.v1.projects.builds.create
        args:
          projectId: ${project_id}
          parent: ${"projects/" + project_id + "/locations/" + location_id}
          body:
            # Configure Cloud Build to run as service account
            serviceAccount: "projects/probable-cove-474504-p0/serviceAccounts/ansible-automation@probable-cove-474504-p0.iam.gserviceaccount.com"
            
            # Required logging configuration when using custom service account
            options:
              logging: "CLOUD_LOGGING_ONLY"
              dynamic_substitutions: true
            
            steps:
              - name: "gcr.io/cloud-builders/gcloud"
                entrypoint: "bash"
                args:
                  - -c
                  - |
                    echo "Verifying VM: ${_TARGET_VM} in zone: ${_VM_ZONE}"
                    
                    # Check if VM exists and is running
                    VM_STATUS=$$(gcloud compute instances describe ${_TARGET_VM} \
                      --zone=${_VM_ZONE} \
                      --format="value(status)" 2>/dev/null || echo "NOT_FOUND")
                    
                    if [ "$$VM_STATUS" = "NOT_FOUND" ]; then
                      echo "ERROR: VM ${_TARGET_VM} not found in zone ${_VM_ZONE}"
                      exit 1
                    elif [ "$$VM_STATUS" != "RUNNING" ]; then
                      echo "ERROR: VM ${_TARGET_VM} is not running. Status: $$VM_STATUS"
                      exit 1
                    fi
                    
                    echo "SUCCESS: VM ${_TARGET_VM} is running"
                    echo "VM_VERIFIED" > $$BUILDER_OUTPUT/output
            
            substitutions:
              _TARGET_VM: ${target_vm}
              _VM_ZONE: ${vm_zone}
            
            tags: ["ansible-workflow", "vm-verification"]
        result: vm_check_result
    
    - return_vm_status:
        return: ${text.decode(base64.decode(vm_check_result.metadata.build.results.buildStepOutputs[0]))}

# =========================================================================
# FUNCTION: RUN ANSIBLE PLAYBOOK
# =========================================================================
run_ansible_playbook:
  params: [project_id, location_id, target_vm, vm_zone, playbook, ansible_user, service_account, git_repo, git_branch, deployment_id]
  steps:
    - ansible_build:
        call: googleapis.cloudbuild.v1.projects.builds.create
        args:
          projectId: ${project_id}
          parent: ${"projects/" + project_id + "/locations/" + location_id}
          body:
            source:
              gitSource:
                url: ${git_repo}
                revision: ${git_branch}
            
            # Configure Cloud Build to run as service account
            serviceAccount: "projects/probable-cove-474504-p0/serviceAccounts/ansible-automation@probable-cove-474504-p0.iam.gserviceaccount.com"
            
            # Required logging configuration when using custom service account
            options:
              logging: "CLOUD_LOGGING_ONLY"
              dynamic_substitutions: true
            
            steps:
              # Step 1: Setup Ansible environment
              - name: "gcr.io/cloud-builders/gcloud"
                entrypoint: "bash"
                args:
                  - -c
                  - |
                    echo "=== Setting up Ansible Environment ==="
                    
                    # Install Ansible
                    python3 -m pip install ansible google-auth google-cloud-compute
                    
                    # Verify installation
                    ansible --version
                    
                    echo "Ansible environment ready"

              # Step 2: Configure dynamic inventory
              - name: "gcr.io/cloud-builders/gcloud"
                entrypoint: "bash"
                args:
                  - -c
                  - |
                    echo "=== Configuring Dynamic Inventory ==="
                    
                    # Create dynamic hosts file
                    cat > hosts-runtime-dynamic.yml << EOF
                    all:
                      children:
                        targets:
                          hosts:
                            ${_TARGET_VM}:
                              ansible_host: ${_TARGET_VM}
                              ansible_user: ${_ANSIBLE_USER}
                              ansible_ssh_common_args: >-
                                -o ProxyCommand="gcloud compute start-iap-tunnel ${_TARGET_VM} 22 
                                --listen-on-stdin --project=${_PROJECT_ID} --zone=${_VM_ZONE}
                                --impersonate-service-account=ansible-automation@probable-cove-474504-p0.iam.gserviceaccount.com
                                --verbosity=warning" 
                                -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
                                -o ConnectTimeout=30 -o ServerAliveInterval=30
                              ansible_python_interpreter: auto_silent
                              ansible_ssh_private_key_file: ''
                          vars:
                            gcp_project: "${_PROJECT_ID}"
                            gcp_zone: "${_VM_ZONE}"
                    EOF
                    
                    echo "Dynamic inventory created"
                    cat hosts-runtime-dynamic.yml

              # Step 3: Test IAP connectivity
              - name: "gcr.io/cloud-builders/gcloud"
                entrypoint: "bash"
                args:
                  - -c
                  - |
                    echo "=== Testing IAP Connectivity ==="
                    
                    # Test Ansible ping
                    timeout 120 ansible all -i hosts-runtime-dynamic.yml -m ping || {
                      echo "ERROR: Failed to connect to ${_TARGET_VM} via IAP"
                      echo "Troubleshooting info:"
                      gcloud compute instances describe ${_TARGET_VM} --zone=${_VM_ZONE} --format="table(name,status,machineType.basename(),networkInterfaces[0].networkIP:label=INTERNAL_IP)"
                      exit 1
                    }
                    
                    echo "SUCCESS: IAP connectivity verified"

              # Step 4: Execute Ansible playbook
              - name: "gcr.io/cloud-builders/gcloud"
                entrypoint: "bash"
                args:
                  - -c
                  - |
                    echo "=== Executing Ansible Playbook: ${_PLAYBOOK} ==="
                    
                    # Run the playbook
                    ansible-playbook -i hosts-runtime-dynamic.yml \
                      playbooks/${_PLAYBOOK} \
                      -v \
                      --timeout=60 \
                      --extra-vars "deployment_id=${_DEPLOYMENT_ID}" | tee deployment.log
                    
                    # Check if playbook succeeded
                    if [ $${PIPESTATUS[0]} -ne 0 ]; then
                      echo "ERROR: Playbook execution failed"
                      tail -50 deployment.log
                      exit 1
                    fi
                    
                    echo "SUCCESS: Playbook ${_PLAYBOOK} completed"
                    echo "DEPLOYMENT_SUCCESS" > $$BUILDER_OUTPUT/output

            substitutions:
              _PROJECT_ID: ${project_id}
              _TARGET_VM: ${target_vm}
              _VM_ZONE: ${vm_zone}
              _PLAYBOOK: ${playbook}
              _ANSIBLE_USER: ${ansible_user}
              _DEPLOYMENT_ID: ${deployment_id}
            
            tags: ["ansible-workflow", "playbook-execution", "${deployment_id}"]
            
            timeout: "1800s"  # 30 minutes timeout
        result: ansible_result

    - return_deployment_result:
        return: ${text.decode(base64.decode(ansible_result.metadata.build.results.buildStepOutputs[0]))}

# =========================================================================
# FUNCTION: RUN VALIDATION
# =========================================================================
run_validation:
  params: [project_id, location_id, target_vm, vm_zone, ansible_user, service_account, deployment_id]
  steps:
    - validation_build:
        call: googleapis.cloudbuild.v1.projects.builds.create
        args:
          projectId: ${project_id}
          parent: ${"projects/" + project_id + "/locations/" + location_id}
          body:
            source:
              gitSource:
                url: "https://github.com/anudishu/ansible-updated-code-iap.git"
                revision: "master"
            
            # Configure Cloud Build to run as service account
            serviceAccount: "projects/probable-cove-474504-p0/serviceAccounts/ansible-automation@probable-cove-474504-p0.iam.gserviceaccount.com"
            
            # Required logging configuration when using custom service account
            options:
              logging: "CLOUD_LOGGING_ONLY"
              dynamic_substitutions: true
            
            steps:
              - name: "gcr.io/cloud-builders/gcloud"
                entrypoint: "bash"
                args:
                  - -c
                  - |
                    echo "=== Running Post-Deployment Validation ==="
                    
                    # Install Ansible
                    python3 -m pip install ansible google-auth google-cloud-compute
                    
                    # Create dynamic hosts file for validation
                    cat > hosts-validation.yml << EOF
                    all:
                      children:
                        targets:
                          hosts:
                            ${_TARGET_VM}:
                              ansible_host: ${_TARGET_VM}
                              ansible_user: ${_ANSIBLE_USER}
                              ansible_ssh_common_args: >-
                                -o ProxyCommand="gcloud compute start-iap-tunnel ${_TARGET_VM} 22 
                                --listen-on-stdin --project=${_PROJECT_ID} --zone=${_VM_ZONE}
                                --impersonate-service-account=ansible-automation@probable-cove-474504-p0.iam.gserviceaccount.com
                                --verbosity=warning" 
                                -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
                              ansible_python_interpreter: auto_silent
                              ansible_ssh_private_key_file: ''
                    EOF
                    
                    # Copy validation scripts to VM
                    ansible all -i hosts-validation.yml -m copy \
                      -a "src=validation/ dest=/tmp/ mode='preserve'"
                    
                    # Run validation
                    ansible all -i hosts-validation.yml -m shell \
                      -a "/tmp/validate_all.sh --verbose" \
                      --become | tee validation.log
                    
                    # Extract validation summary
                    if grep -q "✅ ALL VALIDATIONS PASSED" validation.log; then
                      echo "VALIDATION_PASSED" > $$BUILDER_OUTPUT/output
                    elif grep -q "❌ VALIDATION FAILURES" validation.log; then
                      echo "VALIDATION_FAILED" > $$BUILDER_OUTPUT/output
                    else
                      echo "VALIDATION_INCOMPLETE" > $$BUILDER_OUTPUT/output
                    fi
                    
                    # Always show validation summary
                    echo "=== Validation Summary ==="
                    tail -20 validation.log

            substitutions:
              _PROJECT_ID: ${project_id}
              _TARGET_VM: ${target_vm}
              _VM_ZONE: ${vm_zone}
              _ANSIBLE_USER: ${ansible_user}
            
            tags: ["ansible-workflow", "validation", "${deployment_id}"]
            
            timeout: "600s"  # 10 minutes timeout
        result: validation_result

    - return_validation_result:
        return: ${text.decode(base64.decode(validation_result.metadata.build.results.buildStepOutputs[0]))}

# =========================================================================
# ERROR HANDLING
# =========================================================================
# All steps include automatic error handling and logging through Cloud Build
# Failed builds will automatically surface errors in the workflow execution
# =========================================================================
